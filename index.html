<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Creador de Cartas D&D Épico - Personalizado</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=MedievalSharp&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --card-gold: #c5a059;
            --card-border: #2a1b10;
            --info-box-bg: rgba(253, 246, 227, 0.8); 
            /* Variables de color de texto */
            --text-primary: #2a1b10;
            --text-accent: #7c2d12;
            --text-secondary: #71717a;
        }
        
        body {
            background-color: #0f172a;
            color: #e2e8f0;
            font-family: 'Inter', sans-serif;
        }

        .fantasy-font { font-family: 'Cinzel', serif; }
        .medieval-font { font-family: 'MedievalSharp', cursive; }

        .card-container {
            width: 350px;
            height: 540px;
            perspective: 1000px;
        }

        .spell-card {
            width: 350px;
            height: 540px;
            background-color: #fdf6e3;
            background-size: cover;
            background-position: center;
            color: var(--text-primary);
            border: 10px solid var(--card-border);
            border-radius: 8px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            padding: 10px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            gap: 6px;
        }

        .spell-card::after {
            content: '';
            position: absolute;
            top: 2px; left: 2px; right: 2px; bottom: 2px;
            border: 1px solid var(--card-gold);
            pointer-events: none;
            border-radius: 4px;
            z-index: 5;
        }

        .info-box {
            background: var(--info-box-bg);
            border: 1px solid rgba(197, 160, 89, 0.2);
            border-radius: 4px;
            padding: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: relative;
            z-index: 10;
        }

        .header-section { border-bottom: 2px solid var(--card-border); }

        .stat-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px;
            font-size: 0.75rem;
        }

        .stat-item {
            background: rgba(0,0,0,0.03);
            padding: 2px 6px;
            border-radius: 2px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-label {
            font-weight: bold;
            font-size: 0.55rem;
            text-transform: uppercase;
            color: var(--text-accent);
        }

        .components-bar {
            display: flex;
            gap: 4px;
            align-items: center;
            justify-content: center;
            padding: 4px 0;
            margin-top: 2px;
        }

        .comp-icon {
            display: flex;
            align-items: center;
            gap: 2px;
            font-size: 0.6rem;
            font-weight: bold;
        }

        .description-area {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            text-align: justify;
            line-height: 1.2;
        }

        .higher-levels-label {
            font-weight: 800;
            display: inline;
            color: var(--text-accent);
        }

        input, textarea, select {
            background: #1e293b;
            border: 1px solid #334155;
            color: white;
            padding: 6px;
            border-radius: 4px;
            width: 100%;
            font-size: 0.85rem;
        }

        .control-group {
            background: #1e293b;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        label {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 2px;
            display: block;
        }

        .icon-active { opacity: 1; color: var(--text-accent); }
        .icon-inactive { opacity: 0.2; color: var(--text-secondary); }

        .btn-export {
            background: linear-gradient(to bottom right, #f59e0b, #d97706);
            color: white;
            font-weight: bold;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #0f172a; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }

        .footer-box {
            background: var(--info-box-bg);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.5rem;
            text-transform: uppercase;
            font-weight: bold;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
            z-index: 10;
        }

        .color-picker-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
        }

        /* Indicador visual de error de carga */
        .img-error {
            border: 1px solid #ef4444 !important;
            animation: shake 0.5s ease-in-out;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-4px); }
            75% { transform: translateX(4px); }
        }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col md:flex-row gap-6 justify-center items-start">

    <!-- Panel de Control -->
    <div class="w-full md:w-96 overflow-y-auto max-h-[95vh] pr-2 custom-scrollbar">
        <h2 class="text-xl font-bold mb-4 text-amber-500 fantasy-font">Maestro de Hechizos</h2>
        
        <div class="mb-4">
            <button onclick="exportJPG()" class="btn-export">
                <i data-lucide="download"></i> Descargar Imagen
            </button>
        </div>

        <!-- SECCIÓN 1: DISEÑO Y COLORES -->
        <div class="control-group">
            <label class="font-bold text-amber-500 mb-2 border-b border-zinc-700 pb-1">1. Estética y Colores</label>
            
            <label>Imagen de Fondo (URL)</label>
            <input type="text" id="in-bg-url" placeholder="URL de textura o imagen" oninput="debouncedUpdate()" class="mb-4">
            
            <label class="mb-1">Colores del Texto</label>
            <div class="color-picker-grid mb-4">
                <div>
                    <label class="text-[0.6rem]">Texto Principal</label>
                    <input type="color" id="col-primary" value="#2a1b10" oninput="update()">
                </div>
                <div>
                    <label class="text-[0.6rem]">Texto Acento</label>
                    <input type="color" id="col-accent" value="#7c2d12" oninput="update()">
                </div>
                <div>
                    <label class="text-[0.6rem]">Texto Secund.</label>
                    <input type="color" id="col-secondary" value="#71717a" oninput="update()">
                </div>
            </div>

            <label class="mb-1">Personalización de Cuadros (Boxes)</label>
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label class="text-[0.6rem]">Color Fondo Box</label>
                    <input type="color" id="col-box" value="#fdf6e3" oninput="update()">
                </div>
                <div>
                    <label class="text-[0.6rem]">Opacidad (%)</label>
                    <input type="range" id="range-opacity" min="0" max="1" step="0.01" value="0.8" oninput="update()">
                </div>
            </div>
        </div>

        <!-- SECCIÓN 2: INFORMACIÓN -->
        <div class="control-group">
            <label class="font-bold text-amber-500 mb-2 border-b border-zinc-700 pb-1">2. Información del Hechizo</label>
            <input type="text" id="in-name" value="Bola de Fuego" oninput="update()" class="mb-2" placeholder="Nombre (ES)">
            <input type="text" id="in-name-en" value="Fireball" oninput="update()" placeholder="Nombre (EN)">
            
            <div class="grid grid-cols-2 gap-2 mt-2">
                <div>
                    <label>Nivel</label>
                    <input type="number" id="in-level" min="0" max="9" value="3" oninput="update()">
                </div>
                <div>
                    <label>Escuela</label>
                    <select id="in-school" onchange="update()">
                        <option value="Abjuración">Abjuración</option>
                        <option value="Adivinación">Adivinación</option>
                        <option value="Conjuración">Conjuración</option>
                        <option value="Encantamiento">Encantamiento</option>
                        <option value="Evocación" selected>Evocación</option>
                        <option value="Ilusionismo">Ilusionismo</option>
                        <option value="Nigromancia">Nigromancia</option>
                        <option value="Transmutación">Transmutación</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="control-group">
            <label class="font-bold text-amber-500 mb-2 border-b border-zinc-700 pb-1">3. Alcance y Área</label>
            <div class="flex items-center gap-2 mb-2">
                <input type="checkbox" id="in-touch" onchange="toggleTouch()" class="w-4 h-4">
                <span class="text-xs text-zinc-300">Es de Toque</span>
            </div>
            <div id="range-inputs" class="grid grid-cols-3 gap-2 mb-2">
                <input type="number" id="in-m" placeholder="m" value="45" oninput="update()">
                <input type="number" id="in-ft" placeholder="ft" value="150" oninput="update()">
                <input type="number" id="in-sq" placeholder="Cas" value="30" oninput="update()">
            </div>
            <select id="in-shape" onchange="update()" class="mb-2">
                <option value="none">Sin área específica</option>
                <option value="cone">Cono</option>
                <option value="sphere">Esfera / Radio</option>
                <option value="line">Línea</option>
                <option value="cube">Cubo</option>
                <option value="cylinder">Cilindro</option>
            </select>
            
            <div class="grid grid-cols-5 gap-1 mt-1">
                <label class="text-[0.65rem] text-center"><input type="checkbox" id="in-v" onchange="update()" checked> V</label>
                <label class="text-[0.65rem] text-center"><input type="checkbox" id="in-s" onchange="update()" checked> S</label>
                <label class="text-[0.65rem] text-center"><input type="checkbox" id="in-m-check" onchange="update()" checked> M</label>
                <label class="text-[0.65rem] text-center"><input type="checkbox" id="in-rit" onchange="update()"> Rit</label>
                <label class="text-[0.65rem] text-center"><input type="checkbox" id="in-con" onchange="update()"> Con</label>
            </div>
            <input type="text" id="in-m-text" value="Una bola de guano de murciélago y azufre." oninput="update()" class="mt-2" placeholder="Detalles de materiales...">
        </div>

        <div class="control-group">
            <label class="font-bold text-amber-500 mb-2 border-b border-zinc-700 pb-1">4. Tiempos y Clase</label>
            <div class="grid grid-cols-2 gap-2 mb-2">
                <input type="text" id="in-time" value="1 acción" oninput="update()" placeholder="T. Ejecución">
                <input type="text" id="in-duration" value="Instantáneo" oninput="update()" placeholder="Duración">
            </div>
            <select id="in-class" onchange="update()">
                <option value="mago">Mago</option>
                <option value="hechicero">Hechicero</option>
                <option value="brujo">Brujo</option>
                <option value="clerigo">Clérigo</option>
                <option value="bardo">Bardo</option>
                <option value="paladin">Paladín</option>
                <option value="cazador">Cazador</option>
                <option value="artificer">Artífice</option>
            </select>
        </div>

        <div class="control-group">
            <label class="font-bold text-amber-500 mb-2 border-b border-zinc-700 pb-1">5. Efectos</label>
            <textarea id="in-desc" rows="4" oninput="update()" class="mb-2">Un rayo brillante surge de tu dedo índice hacia un punto que elijas dentro del alcance y luego estalla con un estruendo de llamas en una esfera de 20 pies de radio. Cada criatura en el área debe realizar una tirada de salvación de Destreza.</textarea>
            <textarea id="in-higher" rows="2" oninput="update()" placeholder="A niveles superiores...">Cuando lanzas este conjuro usando un espacio de conjuro de nivel 4 o superior, el daño aumenta en 1d6 por cada nivel de espacio por encima de 3.</textarea>
        </div>

        <div class="control-group">
            <label>6. Origen</label>
            <input type="text" id="in-source" value="PHB'14 - p.234" oninput="update()">
        </div>
    </div>

    <!-- Renderizado de la Carta -->
    <div class="card-container">
        <div class="spell-card" id="card">
            
            <!-- Header -->
            <div class="info-box header-section">
                <div class="flex justify-between items-start">
                    <div class="flex flex-col">
                        <span id="card-name" class="fantasy-font text-lg font-bold leading-tight" style="color: var(--text-primary)">Bola de Fuego</span>
                        <span id="card-name-en" class="italic text-[0.6rem]" style="color: var(--text-secondary)">Fireball</span>
                    </div>
                    <div class="flex flex-col items-end">
                        <span id="card-lvl-school" class="fantasy-font text-[0.6rem] font-bold text-right" style="color: var(--text-accent)">NIVEL 3 - EVOCACIÓN</span>
                        <div class="mt-1">
                            <i id="card-class-icon" data-lucide="wand-2" class="w-5 h-5" style="color: var(--text-accent)"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats -->
            <div class="info-box">
                <div class="stat-grid">
                    <div class="stat-item">
                        <span class="stat-label">T. Ejecución</span>
                        <span id="card-time" class="text-[0.6rem] font-semibold">1 acción</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Alcance / Área</span>
                        <div class="flex items-center gap-1">
                            <i id="card-shape-icon" data-lucide="circle" class="w-3 h-3 hidden"></i>
                            <span id="card-range" class="text-[0.6rem] font-semibold">45m / 150ft / 30c</span>
                        </div>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Duración</span>
                        <span id="card-duration" class="text-[0.6rem] font-semibold">Instantáneo</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Clase</span>
                        <span id="card-class-name" class="text-[0.6rem] font-semibold capitalize">Mago</span>
                    </div>
                </div>

                <div class="components-bar">
                    <div id="ico-v" class="comp-icon"><i data-lucide="mic" class="w-2.5 h-2.5"></i>V</div>
                    <div id="ico-s" class="comp-icon"><i data-lucide="hand" class="w-2.5 h-2.5"></i>S</div>
                    <div id="ico-m" class="comp-icon"><i data-lucide="package" class="w-2.5 h-2.5"></i>M</div>
                    <div class="w-px h-2.5 bg-zinc-400 mx-0.5 opacity-30"></div>
                    <div id="ico-rit" class="comp-icon"><i data-lucide="sparkles" class="w-2.5 h-2.5"></i>RIT</div>
                    <div id="ico-con" class="comp-icon"><i data-lucide="brain" class="w-2.5 h-2.5"></i>CONC</div>
                </div>
            </div>

            <div id="card-m-desc" class="info-box text-[0.55rem] leading-tight italic border-l-4" style="border-color: var(--text-accent); color: var(--text-secondary)">
                M: Una bola de guano de murciélago y azufre.
            </div>

            <div class="info-box description-area" id="desc-container">
                <div id="card-content-wrapper" style="color: var(--text-primary)">
                    <div id="card-desc-main" class="mb-1"></div>
                    <div id="card-higher-area" class="mt-2 pt-1 border-t border-black/5">
                        <span class="higher-levels-label">A niveles superiores:</span>
                        <span id="card-higher-text"></span>
                    </div>
                </div>
            </div>

            <div class="footer-box">
                <span id="card-source-footer">PHB'14 - p.234</span>
                <span>D&D 5ª Edición</span>
            </div>
        </div>
    </div>

    <script>
        const classIcons = { mago: 'wand-2', hechicero: 'zap', brujo: 'eye', clerigo: 'cross', bardo: 'music', paladin: 'shield', cazador: 'target', artificer: 'hammer' };
        const shapeIcons = { cone: 'triangle', sphere: 'circle', line: 'move-right', cube: 'square', cylinder: 'database', none: '' };

        let updateTimeout;

        function hexToRgb(hex) {
            const r = parseInt(hex.slice(1, 3), 16);
            const g = parseInt(hex.slice(3, 5), 16);
            const b = parseInt(hex.slice(5, 7), 16);
            return `${r}, ${g}, ${b}`;
        }

        function toggleTouch() {
            const isTouch = document.getElementById('in-touch').checked;
            const inputs = document.getElementById('range-inputs');
            inputs.style.opacity = isTouch ? "0.3" : "1";
            inputs.style.pointerEvents = isTouch ? "none" : "auto";
            update();
        }

        // Función para evitar errores de consola al escribir URLs incompletas
        function debouncedUpdate() {
            clearTimeout(updateTimeout);
            updateTimeout = setTimeout(update, 500);
        }

        function update() {
            const root = document.documentElement;
            
            // Colores de Texto
            const colPrimary = document.getElementById('col-primary').value;
            const colAccent = document.getElementById('col-accent').value;
            const colSecondary = document.getElementById('col-secondary').value;
            root.style.setProperty('--text-primary', colPrimary);
            root.style.setProperty('--text-accent', colAccent);
            root.style.setProperty('--text-secondary', colSecondary);

            // Color y Opacidad de Cuadros (Boxes)
            const boxColorHex = document.getElementById('col-box').value;
            const boxOpacity = document.getElementById('range-opacity').value;
            const boxRgb = hexToRgb(boxColorHex);
            root.style.setProperty('--info-box-bg', `rgba(${boxRgb}, ${boxOpacity})`);

            // Validación de Imagen de Fondo
            const bgInput = document.getElementById('in-bg-url');
            const bgUrl = bgInput.value.trim();
            const card = document.getElementById('card');

            if (bgUrl) {
                // Pre-cargamos la imagen para verificar que existe y no de error de red
                const tempImg = new Image();
                tempImg.onload = () => {
                    card.style.backgroundImage = `url('${bgUrl}')`;
                    bgInput.classList.remove('img-error');
                };
                tempImg.onerror = () => {
                    // Si falla la carga, quitamos el fondo y marcamos error visualmente en el input
                    card.style.backgroundImage = 'none';
                    bgInput.classList.add('img-error');
                    console.warn("La imagen de fondo no pudo cargarse o tiene restricciones de CORS.");
                };
                tempImg.src = bgUrl;
            } else {
                card.style.backgroundImage = 'none';
                bgInput.classList.remove('img-error');
            }

            // Actualización de Contenido
            document.getElementById('card-name').innerText = document.getElementById('in-name').value;
            document.getElementById('card-name-en').innerText = document.getElementById('in-name-en').value;
            const level = parseInt(document.getElementById('in-level').value);
            const school = document.getElementById('in-school').value;
            document.getElementById('card-lvl-school').innerText = `${level === 0 ? "TRUCO" : "NIVEL " + level} - ${school.toUpperCase()}`;
            
            const className = document.getElementById('in-class').value;
            document.getElementById('card-class-icon').setAttribute('data-lucide', classIcons[className] || 'help-circle');
            document.getElementById('card-class-name').innerText = className;
            document.getElementById('card-time').innerText = document.getElementById('in-time').value;
            document.getElementById('card-duration').innerText = document.getElementById('in-duration').value;

            const isTouch = document.getElementById('in-touch').checked;
            const shape = document.getElementById('in-shape').value;
            const rangeTextEl = document.getElementById('card-range');
            const shapeIconEl = document.getElementById('card-shape-icon');
            
            if (isTouch) {
                rangeTextEl.innerText = "Toque";
                shapeIconEl.setAttribute('data-lucide', 'hand');
                shapeIconEl.classList.remove('hidden');
            } else {
                rangeTextEl.innerText = `${document.getElementById('in-m').value}m / ${document.getElementById('in-ft').value}ft / ${document.getElementById('in-sq').value}c`;
                if (shape !== 'none') {
                    shapeIconEl.setAttribute('data-lucide', shapeIcons[shape]);
                    shapeIconEl.classList.remove('hidden');
                    shapeIconEl.style.transform = shape === 'cone' ? "rotate(180deg)" : "rotate(0deg)";
                } else {
                    shapeIconEl.classList.add('hidden');
                }
            }

            const checkMap = { 'ico-v': 'in-v', 'ico-s': 'in-s', 'ico-m': 'in-m-check', 'ico-rit': 'in-rit', 'ico-con': 'in-con' };
            Object.keys(checkMap).forEach(id => {
                const active = document.getElementById(checkMap[id]).checked;
                document.getElementById(id).className = `comp-icon ${active ? 'icon-active' : 'icon-inactive'}`;
            });

            const mText = document.getElementById('in-m-text').value;
            const mContainer = document.getElementById('card-m-desc');
            mContainer.style.display = (document.getElementById('in-m-check').checked && mText) ? 'block' : 'none';
            if(mContainer.style.display !== 'none') mContainer.innerText = `M: ${mText}`;

            document.getElementById('card-desc-main').innerHTML = document.getElementById('in-desc').value.replace(/\n/g, '<br>');
            const higher = document.getElementById('in-higher').value;
            const higherArea = document.getElementById('card-higher-area');
            if(higher.trim()) {
                higherArea.style.display = 'block';
                document.getElementById('card-higher-text').innerText = " " + higher;
            } else {
                higherArea.style.display = 'none';
            }

            document.getElementById('card-source-footer').innerText = document.getElementById('in-source').value;

            autoScaleFont();
            lucide.createIcons();
        }

        function autoScaleFont() {
            const container = document.getElementById('desc-container');
            const content = document.getElementById('card-content-wrapper');
            let fontSize = 14; 
            content.style.fontSize = fontSize + 'px';
            while (content.scrollHeight > container.offsetHeight - 16 && fontSize > 6) {
                fontSize -= 0.2;
                content.style.fontSize = fontSize + 'px';
            }
        }

        async function exportJPG() {
            const cardElement = document.getElementById('card');
            const spellName = document.getElementById('in-name').value || 'hechizo';
            const options = { scale: 3, backgroundColor: '#ffffff', useCORS: true, allowTaint: true };
            try {
                const canvas = await html2canvas(cardElement, options);
                const link = document.createElement('a');
                link.download = `D&D_Spell_${spellName.replace(/\s+/g, '_')}.jpg`;
                link.href = canvas.toDataURL('image/jpeg', 0.9);
                link.click();
            } catch (e) { 
                console.error("Error al exportar la imagen. Verifica si la imagen de fondo tiene restricciones de CORS.", e); 
            }
        }

        window.onload = () => { update(); setTimeout(autoScaleFont, 100); };
    </script>
</body>
</html>
